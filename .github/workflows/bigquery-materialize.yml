# BigQuery Analytics Materialization
# Runs daily at 2:00 PM IST (8:30 UTC) to materialize analytics views into tables
# This makes Looker dashboards faster and creates daily snapshots

name: Materialize BigQuery Analytics

on:
  schedule:
    # Runs at 2:00 PM IST (8:30 UTC) daily
    - cron: '30 8 * * *'

  # Allow manual trigger from GitHub Actions tab
  workflow_dispatch:

jobs:
  materialize:
    name: Materialize Analytics Tables
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_CREDENTIALS }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: portfolio-483605

      - name: Create materialized dataset if not exists
        run: |
          bq mk --dataset --location=US portfolio-483605:analytics_materialized || true

      - name: Materialize Section Rankings
        run: |
          bq query --use_legacy_sql=false --location=US '
            CREATE OR REPLACE TABLE `portfolio-483605.analytics_materialized.section_rankings` AS
            SELECT *, CURRENT_TIMESTAMP() as materialized_at
            FROM `portfolio-483605.analytics_processed.v_section_rankings`
          '
          echo "Section rankings materialized"

      - name: Materialize Project Rankings
        run: |
          bq query --use_legacy_sql=false --location=US '
            CREATE OR REPLACE TABLE `portfolio-483605.analytics_materialized.project_rankings` AS
            SELECT *, CURRENT_TIMESTAMP() as materialized_at
            FROM `portfolio-483605.analytics_processed.v_project_rankings`
          '
          echo "Project rankings materialized"

      - name: Materialize Skill Rankings
        run: |
          bq query --use_legacy_sql=false --location=US '
            CREATE OR REPLACE TABLE `portfolio-483605.analytics_materialized.skill_rankings` AS
            SELECT *, CURRENT_TIMESTAMP() as materialized_at
            FROM `portfolio-483605.analytics_processed.v_skill_rankings`
          '
          echo "Skill rankings materialized"

      - name: Materialize Client Rankings
        run: |
          bq query --use_legacy_sql=false --location=US '
            CREATE OR REPLACE TABLE `portfolio-483605.analytics_materialized.client_rankings` AS
            SELECT *, CURRENT_TIMESTAMP() as materialized_at
            FROM `portfolio-483605.analytics_processed.v_client_rankings`
          '
          echo "Client rankings materialized"

      - name: Materialize Domain Rankings
        run: |
          bq query --use_legacy_sql=false --location=US '
            CREATE OR REPLACE TABLE `portfolio-483605.analytics_materialized.domain_rankings` AS
            SELECT *, CURRENT_TIMESTAMP() as materialized_at
            FROM `portfolio-483605.analytics_processed.v_domain_rankings`
          '
          echo "Domain rankings materialized"

      - name: Materialize Experience Rankings
        run: |
          bq query --use_legacy_sql=false --location=US '
            CREATE OR REPLACE TABLE `portfolio-483605.analytics_materialized.experience_rankings` AS
            SELECT *, CURRENT_TIMESTAMP() as materialized_at
            FROM `portfolio-483605.analytics_processed.v_experience_rankings`
          '
          echo "Experience rankings materialized"

      - name: Materialize Tech Demand Insights
        run: |
          bq query --use_legacy_sql=false --location=US '
            CREATE OR REPLACE TABLE `portfolio-483605.analytics_materialized.tech_demand_insights` AS
            SELECT *, CURRENT_TIMESTAMP() as materialized_at
            FROM `portfolio-483605.analytics_processed.v_tech_demand_insights`
          '
          echo "Tech demand insights materialized"

      - name: Materialize Visitor Insights
        run: |
          bq query --use_legacy_sql=false --location=US '
            CREATE OR REPLACE TABLE `portfolio-483605.analytics_materialized.visitor_insights` AS
            SELECT *, CURRENT_TIMESTAMP() as materialized_at
            FROM `portfolio-483605.analytics_processed.v_visitor_insights`
          '
          echo "Visitor insights materialized"

      - name: Materialize Conversion Funnel
        run: |
          bq query --use_legacy_sql=false --location=US '
            CREATE OR REPLACE TABLE `portfolio-483605.analytics_materialized.conversion_funnel` AS
            SELECT *, CURRENT_TIMESTAMP() as materialized_at
            FROM `portfolio-483605.analytics_processed.v_conversion_funnel`
          '
          echo "Conversion funnel materialized"

      - name: Materialize Recommendation Performance
        run: |
          bq query --use_legacy_sql=false --location=US '
            CREATE OR REPLACE TABLE `portfolio-483605.analytics_materialized.recommendation_performance` AS
            SELECT *, CURRENT_TIMESTAMP() as materialized_at
            FROM `portfolio-483605.analytics_processed.v_recommendation_performance`
          '
          echo "Recommendation performance materialized"

      # Export rankings to JSON for frontend consumption
      - name: Create data directory
        run: mkdir -p public/data

      - name: Export Skill Rankings to JSON
        run: |
          bq query --use_legacy_sql=false --format=json --location=US '
            SELECT
              technology as skill_name,
              skill_category,
              total_interest_signals as clicks,
              demand_rank,
              demand_tier,
              learning_priority
            FROM `portfolio-483605.analytics_materialized.tech_demand_insights`
            ORDER BY demand_rank
          ' > public/data/skill-rankings.json
          echo "Skill rankings exported to JSON"

      - name: Export Project Rankings to JSON
        run: |
          bq query --use_legacy_sql=false --format=json --location=US '
            SELECT
              project_id,
              project_title,
              overall_rank,
              total_views,
              total_clicks,
              engagement_score,
              recommended_position
            FROM `portfolio-483605.analytics_materialized.project_rankings`
            ORDER BY overall_rank
          ' > public/data/project-rankings.json
          echo "Project rankings exported to JSON"

      - name: Export Section Rankings to JSON
        run: |
          bq query --use_legacy_sql=false --format=json --location=US '
            SELECT
              section_id,
              health_score,
              engagement_rank,
              health_tier,
              optimization_hint
            FROM `portfolio-483605.analytics_materialized.section_rankings`
            ORDER BY engagement_rank
          ' > public/data/section-rankings.json
          echo "Section rankings exported to JSON"

      - name: Add timestamp to rankings
        run: |
          echo "{\"updated_at\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}" > public/data/rankings-meta.json

      - name: Commit and push rankings data
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add public/data/*.json
          git diff --staged --quiet || git commit -m "Update analytics rankings data [skip ci]"
          git push

      - name: Summary
        run: |
          echo "========================================"
          echo "Materialization Complete!"
          echo "========================================"
          echo "Tables updated in analytics_materialized:"
          echo "  - section_rankings"
          echo "  - project_rankings"
          echo "  - skill_rankings"
          echo "  - client_rankings"
          echo "  - domain_rankings"
          echo "  - experience_rankings"
          echo "  - tech_demand_insights"
          echo "  - visitor_insights"
          echo "  - conversion_funnel"
          echo "  - recommendation_performance"
          echo ""
          echo "JSON files exported to public/data/:"
          echo "  - skill-rankings.json"
          echo "  - project-rankings.json"
          echo "  - section-rankings.json"
          echo "  - rankings-meta.json"
          echo "========================================"
          echo "Timestamp: $(date)"
