# BigQuery Analytics Materialization
# Runs daily at 2:00 PM IST (8:30 UTC) to materialize analytics views into tables
# This makes Looker dashboards faster and creates daily snapshots

name: Materialize BigQuery Analytics

on:
  schedule:
    # Runs at 2:00 PM IST (8:30 UTC) daily
    - cron: '30 8 * * *'

  # Allow manual trigger from GitHub Actions tab
  workflow_dispatch:

jobs:
  materialize:
    name: Materialize Analytics Tables
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_CREDENTIALS }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: portfolio-483605

      - name: Create materialized dataset if not exists
        run: |
          bq mk --dataset --location=US portfolio-483605:analytics_materialized || true

      - name: Materialize Section Rankings
        run: |
          bq query --use_legacy_sql=false --location=US '
            CREATE OR REPLACE TABLE `portfolio-483605.analytics_materialized.section_rankings` AS
            SELECT *, CURRENT_TIMESTAMP() as materialized_at
            FROM `portfolio-483605.analytics_processed.v_section_rankings`
          '
          echo "Section rankings materialized"

      - name: Materialize Project Rankings
        run: |
          bq query --use_legacy_sql=false --location=US '
            CREATE OR REPLACE TABLE `portfolio-483605.analytics_materialized.project_rankings` AS
            SELECT *, CURRENT_TIMESTAMP() as materialized_at
            FROM `portfolio-483605.analytics_processed.v_project_rankings`
          '
          echo "Project rankings materialized"

      - name: Materialize Skill Rankings
        run: |
          bq query --use_legacy_sql=false --location=US '
            CREATE OR REPLACE TABLE `portfolio-483605.analytics_materialized.skill_rankings` AS
            SELECT *, CURRENT_TIMESTAMP() as materialized_at
            FROM `portfolio-483605.analytics_processed.v_skill_rankings`
          '
          echo "Skill rankings materialized"

      - name: Materialize Client Rankings
        run: |
          bq query --use_legacy_sql=false --location=US '
            CREATE OR REPLACE TABLE `portfolio-483605.analytics_materialized.client_rankings` AS
            SELECT *, CURRENT_TIMESTAMP() as materialized_at
            FROM `portfolio-483605.analytics_processed.v_client_rankings`
          '
          echo "Client rankings materialized"

      - name: Materialize Domain Rankings
        run: |
          bq query --use_legacy_sql=false --location=US '
            CREATE OR REPLACE TABLE `portfolio-483605.analytics_materialized.domain_rankings` AS
            SELECT *, CURRENT_TIMESTAMP() as materialized_at
            FROM `portfolio-483605.analytics_processed.v_domain_rankings`
          '
          echo "Domain rankings materialized"

      - name: Materialize Experience Rankings
        run: |
          bq query --use_legacy_sql=false --location=US '
            CREATE OR REPLACE TABLE `portfolio-483605.analytics_materialized.experience_rankings` AS
            SELECT *, CURRENT_TIMESTAMP() as materialized_at
            FROM `portfolio-483605.analytics_processed.v_experience_rankings`
          '
          echo "Experience rankings materialized"

      - name: Materialize Tech Demand Insights
        run: |
          bq query --use_legacy_sql=false --location=US '
            CREATE OR REPLACE TABLE `portfolio-483605.analytics_materialized.tech_demand_insights` AS
            SELECT *, CURRENT_TIMESTAMP() as materialized_at
            FROM `portfolio-483605.analytics_processed.v_tech_demand_insights`
          '
          echo "Tech demand insights materialized"

      - name: Materialize Visitor Insights
        run: |
          bq query --use_legacy_sql=false --location=US '
            CREATE OR REPLACE TABLE `portfolio-483605.analytics_materialized.visitor_insights` AS
            SELECT *, CURRENT_TIMESTAMP() as materialized_at
            FROM `portfolio-483605.analytics_processed.v_visitor_insights`
          '
          echo "Visitor insights materialized"

      - name: Materialize Conversion Funnel
        run: |
          bq query --use_legacy_sql=false --location=US '
            CREATE OR REPLACE TABLE `portfolio-483605.analytics_materialized.conversion_funnel` AS
            SELECT *, CURRENT_TIMESTAMP() as materialized_at
            FROM `portfolio-483605.analytics_processed.v_conversion_funnel`
          '
          echo "Conversion funnel materialized"

      - name: Materialize Recommendation Performance
        run: |
          bq query --use_legacy_sql=false --location=US '
            CREATE OR REPLACE TABLE `portfolio-483605.analytics_materialized.recommendation_performance` AS
            SELECT *, CURRENT_TIMESTAMP() as materialized_at
            FROM `portfolio-483605.analytics_processed.v_recommendation_performance`
          '
          echo "Recommendation performance materialized"

      # Export rankings to JSON and update GitHub Gist
      # Use || echo '[]' to handle empty results gracefully
      - name: Export Skill Rankings to JSON
        run: |
          bq query --use_legacy_sql=false --format=json --location=US '
            SELECT
              technology as skill_name,
              skill_category,
              total_interest_signals as clicks,
              demand_rank,
              demand_tier,
              learning_priority
            FROM `portfolio-483605.analytics_materialized.tech_demand_insights`
            ORDER BY demand_rank
          ' > /tmp/skill-rankings.json || echo '[]' > /tmp/skill-rankings.json
          echo "Skill rankings exported: $(cat /tmp/skill-rankings.json | head -c 100)"

      - name: Export Project Rankings to JSON
        run: |
          bq query --use_legacy_sql=false --format=json --location=US '
            SELECT
              project_id,
              project_title,
              overall_rank,
              total_views,
              total_clicks,
              engagement_score,
              recommended_position
            FROM `portfolio-483605.analytics_materialized.project_rankings`
            ORDER BY overall_rank
          ' > /tmp/project-rankings.json || echo '[]' > /tmp/project-rankings.json
          echo "Project rankings exported: $(cat /tmp/project-rankings.json | head -c 100)"

      - name: Export Section Rankings to JSON
        run: |
          bq query --use_legacy_sql=false --format=json --location=US '
            SELECT
              section_id,
              health_score,
              engagement_rank,
              health_tier,
              optimization_hint
            FROM `portfolio-483605.analytics_materialized.section_rankings`
            ORDER BY engagement_rank
          ' > /tmp/section-rankings.json || echo '[]' > /tmp/section-rankings.json
          echo "Section rankings exported: $(cat /tmp/section-rankings.json | head -c 100)"

      - name: Export Client Rankings to JSON
        run: |
          bq query --use_legacy_sql=false --format=json --location=US '
            SELECT
              client_id,
              client_name,
              experience_id,
              domain,
              engagement_rank,
              total_views,
              total_clicks
            FROM `portfolio-483605.analytics_materialized.client_rankings`
            ORDER BY experience_id, engagement_rank
          ' > /tmp/client-rankings.json || echo '[]' > /tmp/client-rankings.json
          echo "Client rankings exported: $(cat /tmp/client-rankings.json | head -c 100)"

      - name: Update GitHub Gist with rankings data
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
        run: |
          # Ensure all files have valid JSON (default to empty array if invalid)
          for f in /tmp/skill-rankings.json /tmp/project-rankings.json /tmp/section-rankings.json /tmp/client-rankings.json; do
            if ! jq empty "$f" 2>/dev/null; then
              echo '[]' > "$f"
            fi
          done

          # Combine all rankings into one JSON file
          jq -n \
            --argjson skills "$(cat /tmp/skill-rankings.json)" \
            --argjson projects "$(cat /tmp/project-rankings.json)" \
            --argjson sections "$(cat /tmp/section-rankings.json)" \
            --argjson clients "$(cat /tmp/client-rankings.json)" \
            --arg updated_at "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            '{
              skills: $skills,
              projects: $projects,
              sections: $sections,
              clients: $clients,
              updated_at: $updated_at
            }' > /tmp/rankings.json

          echo "Combined rankings JSON:"
          cat /tmp/rankings.json

          # Update Gist via GitHub API
          RESPONSE=$(curl -s -X PATCH \
            -H "Authorization: token $GIST_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/gists/7983bb85c69ec4cc45fe37b6a8d2d391 \
            -d "$(jq -n --arg content "$(cat /tmp/rankings.json)" '{files: {"skill-rankings.json": {content: $content}}}')")

          echo "Gist API Response:"
          echo "$RESPONSE" | head -20

          if echo "$RESPONSE" | grep -q '"id"'; then
            echo "Gist updated successfully!"
          else
            echo "Warning: Gist update may have failed"
            exit 1
          fi

      - name: Summary
        run: |
          echo "========================================"
          echo "Materialization Complete!"
          echo "========================================"
          echo "Tables updated in analytics_materialized:"
          echo "  - section_rankings"
          echo "  - project_rankings"
          echo "  - skill_rankings"
          echo "  - client_rankings"
          echo "  - domain_rankings"
          echo "  - experience_rankings"
          echo "  - tech_demand_insights"
          echo "  - visitor_insights"
          echo "  - conversion_funnel"
          echo "  - recommendation_performance"
          echo ""
          echo "GitHub Gist updated with rankings data:"
          echo "  https://gist.github.com/AbhinavSarkarr/7983bb85c69ec4cc45fe37b6a8d2d391"
          echo "========================================"
          echo "Timestamp: $(date)"
