# BigQuery Analytics Materialization
# Runs daily at 2:00 PM IST (8:30 UTC) to materialize analytics views into tables
# This makes Looker dashboards faster and creates daily snapshots

name: Materialize BigQuery Analytics

on:
  schedule:
    # Runs at 2:00 PM IST (8:30 UTC) daily
    - cron: '30 8 * * *'

  # Allow manual trigger from GitHub Actions tab
  workflow_dispatch:

jobs:
  materialize:
    name: Materialize Analytics Tables
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_CREDENTIALS }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: portfolio-483605

      - name: Create materialized dataset if not exists
        run: |
          bq mk --dataset --location=US portfolio-483605:analytics_materialized || true

      - name: Materialize Section Rankings
        run: |
          bq query --use_legacy_sql=false --location=US '
            CREATE OR REPLACE TABLE `portfolio-483605.analytics_materialized.section_rankings` AS
            SELECT *, CURRENT_TIMESTAMP() as materialized_at
            FROM `portfolio-483605.analytics_processed.v_section_rankings`
          '
          echo "Section rankings materialized"

      - name: Materialize Project Rankings
        run: |
          bq query --use_legacy_sql=false --location=US '
            CREATE OR REPLACE TABLE `portfolio-483605.analytics_materialized.project_rankings` AS
            SELECT *, CURRENT_TIMESTAMP() as materialized_at
            FROM `portfolio-483605.analytics_processed.v_project_rankings`
          '
          echo "Project rankings materialized"

      - name: Materialize Skill Rankings
        run: |
          bq query --use_legacy_sql=false --location=US '
            CREATE OR REPLACE TABLE `portfolio-483605.analytics_materialized.skill_rankings` AS
            SELECT *, CURRENT_TIMESTAMP() as materialized_at
            FROM `portfolio-483605.analytics_processed.v_skill_rankings`
          '
          echo "Skill rankings materialized"

      - name: Materialize Client Rankings
        run: |
          bq query --use_legacy_sql=false --location=US '
            CREATE OR REPLACE TABLE `portfolio-483605.analytics_materialized.client_rankings` AS
            SELECT *, CURRENT_TIMESTAMP() as materialized_at
            FROM `portfolio-483605.analytics_processed.v_client_rankings`
          '
          echo "Client rankings materialized"

      - name: Materialize Domain Rankings
        run: |
          bq query --use_legacy_sql=false --location=US '
            CREATE OR REPLACE TABLE `portfolio-483605.analytics_materialized.domain_rankings` AS
            SELECT *, CURRENT_TIMESTAMP() as materialized_at
            FROM `portfolio-483605.analytics_processed.v_domain_rankings`
          '
          echo "Domain rankings materialized"

      - name: Materialize Experience Rankings
        run: |
          bq query --use_legacy_sql=false --location=US '
            CREATE OR REPLACE TABLE `portfolio-483605.analytics_materialized.experience_rankings` AS
            SELECT *, CURRENT_TIMESTAMP() as materialized_at
            FROM `portfolio-483605.analytics_processed.v_experience_rankings`
          '
          echo "Experience rankings materialized"

      - name: Materialize Tech Demand Insights
        run: |
          bq query --use_legacy_sql=false --location=US '
            CREATE OR REPLACE TABLE `portfolio-483605.analytics_materialized.tech_demand_insights` AS
            SELECT *, CURRENT_TIMESTAMP() as materialized_at
            FROM `portfolio-483605.analytics_processed.v_tech_demand_insights`
          '
          echo "Tech demand insights materialized"

      - name: Materialize Visitor Insights
        run: |
          bq query --use_legacy_sql=false --location=US '
            CREATE OR REPLACE TABLE `portfolio-483605.analytics_materialized.visitor_insights` AS
            SELECT *, CURRENT_TIMESTAMP() as materialized_at
            FROM `portfolio-483605.analytics_processed.v_visitor_insights`
          '
          echo "Visitor insights materialized"

      - name: Materialize Conversion Funnel
        run: |
          bq query --use_legacy_sql=false --location=US '
            CREATE OR REPLACE TABLE `portfolio-483605.analytics_materialized.conversion_funnel` AS
            SELECT *, CURRENT_TIMESTAMP() as materialized_at
            FROM `portfolio-483605.analytics_processed.v_conversion_funnel`
          '
          echo "Conversion funnel materialized"

      - name: Materialize Recommendation Performance
        run: |
          bq query --use_legacy_sql=false --location=US '
            CREATE OR REPLACE TABLE `portfolio-483605.analytics_materialized.recommendation_performance` AS
            SELECT *, CURRENT_TIMESTAMP() as materialized_at
            FROM `portfolio-483605.analytics_processed.v_recommendation_performance`
          '
          echo "Recommendation performance materialized"

      # Export rankings to JSON and update GitHub Gist
      # Use || echo '[]' to handle empty results gracefully
      - name: Export Skill Rankings to JSON
        run: |
          bq query --use_legacy_sql=false --format=json --location=US '
            SELECT
              technology as skill_name,
              skill_category,
              total_interest_signals as clicks,
              demand_rank,
              demand_tier,
              learning_priority
            FROM `portfolio-483605.analytics_materialized.tech_demand_insights`
            ORDER BY demand_rank
          ' > /tmp/skill-rankings.json || echo '[]' > /tmp/skill-rankings.json
          echo "Skill rankings exported: $(cat /tmp/skill-rankings.json | head -c 100)"

      - name: Export Project Rankings to JSON
        run: |
          bq query --use_legacy_sql=false --format=json --location=US '
            SELECT
              project_id,
              project_title,
              overall_rank,
              total_views,
              total_clicks,
              engagement_score,
              recommended_position
            FROM `portfolio-483605.analytics_materialized.project_rankings`
            ORDER BY overall_rank
          ' > /tmp/project-rankings.json || echo '[]' > /tmp/project-rankings.json
          echo "Project rankings exported: $(cat /tmp/project-rankings.json | head -c 100)"

      - name: Export Section Rankings to JSON
        run: |
          bq query --use_legacy_sql=false --format=json --location=US '
            SELECT
              section_id,
              health_score,
              engagement_rank,
              health_tier,
              optimization_hint
            FROM `portfolio-483605.analytics_materialized.section_rankings`
            ORDER BY engagement_rank
          ' > /tmp/section-rankings.json || echo '[]' > /tmp/section-rankings.json
          echo "Section rankings exported: $(cat /tmp/section-rankings.json | head -c 100)"

      - name: Export Client Rankings to JSON
        run: |
          bq query --use_legacy_sql=false --format=json --location=US '
            SELECT
              client_id,
              client_name,
              experience_id,
              domain,
              engagement_rank,
              total_views,
              total_clicks
            FROM `portfolio-483605.analytics_materialized.client_rankings`
            ORDER BY experience_id, engagement_rank
          ' > /tmp/client-rankings.json || echo '[]' > /tmp/client-rankings.json
          echo "Client rankings exported: $(cat /tmp/client-rankings.json | head -c 100)"

      - name: Update GitHub Gist with rankings data
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
        run: |
          # Ensure all files have valid JSON (default to empty array if invalid)
          for f in /tmp/skill-rankings.json /tmp/project-rankings.json /tmp/section-rankings.json /tmp/client-rankings.json; do
            if ! jq empty "$f" 2>/dev/null; then
              echo '[]' > "$f"
            fi
          done

          # Combine all rankings into one JSON file
          jq -n \
            --argjson skills "$(cat /tmp/skill-rankings.json)" \
            --argjson projects "$(cat /tmp/project-rankings.json)" \
            --argjson sections "$(cat /tmp/section-rankings.json)" \
            --argjson clients "$(cat /tmp/client-rankings.json)" \
            --arg updated_at "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            '{
              skills: $skills,
              projects: $projects,
              sections: $sections,
              clients: $clients,
              updated_at: $updated_at
            }' > /tmp/rankings.json

          echo "Combined rankings JSON:"
          cat /tmp/rankings.json

          # Update Gist via GitHub API
          RESPONSE=$(curl -s -X PATCH \
            -H "Authorization: token $GIST_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/gists/7983bb85c69ec4cc45fe37b6a8d2d391 \
            -d "$(jq -n --arg content "$(cat /tmp/rankings.json)" '{files: {"skill-rankings.json": {content: $content}}}')")

          echo "Gist API Response:"
          echo "$RESPONSE" | head -20

          if echo "$RESPONSE" | grep -q '"id"'; then
            echo "Gist updated successfully!"
          else
            echo "Warning: Gist update may have failed"
            exit 1
          fi

      # ==================== DASHBOARD DATA EXPORT ====================
      # Export comprehensive dashboard data to a separate Gist

      - name: Export Daily Metrics to JSON
        run: |
          bq query --use_legacy_sql=false --format=json --location=US '
            SELECT
              FORMAT_DATE("%Y-%m-%d", session_date) as date,
              unique_visitors as visitors,
              total_sessions as sessions,
              ROUND(engagement_rate, 1) as engagement_rate,
              ROUND(bounce_rate, 1) as bounce_rate,
              ROUND(avg_session_duration_sec, 0) as avg_session_duration_sec,
              desktop_sessions as desktop,
              mobile_sessions as mobile,
              tablet_sessions as tablet
            FROM `portfolio-483605.analytics_processed.v_daily_metrics`
            WHERE session_date >= DATE_SUB(CURRENT_DATE(), INTERVAL 30 DAY)
            ORDER BY session_date DESC
            LIMIT 30
          ' > /tmp/daily-metrics.json || echo '[]' > /tmp/daily-metrics.json

      - name: Export Traffic Sources to JSON
        run: |
          bq query --use_legacy_sql=false --format=json --location=US '
            SELECT
              traffic_source as source,
              traffic_medium as medium,
              SUM(sessions) as sessions,
              ROUND(AVG(engagement_rate), 1) as engagement_rate
            FROM `portfolio-483605.analytics_processed.v_traffic_daily_stats`
            WHERE event_date >= DATE_SUB(CURRENT_DATE(), INTERVAL 7 DAY)
            GROUP BY traffic_source, traffic_medium
            ORDER BY sessions DESC
            LIMIT 10
          ' > /tmp/traffic-sources.json || echo '[]' > /tmp/traffic-sources.json

      - name: Export Top Countries to JSON
        run: |
          bq query --use_legacy_sql=false --format=json --location=US '
            SELECT
              country,
              COUNT(DISTINCT user_pseudo_id) as visitors
            FROM `portfolio-483605.analytics_processed.v_sessions`
            WHERE session_date >= DATE_SUB(CURRENT_DATE(), INTERVAL 7 DAY)
            GROUP BY country
            ORDER BY visitors DESC
            LIMIT 10
          ' > /tmp/top-countries.json || echo '[]' > /tmp/top-countries.json

      - name: Export Visitor Segments Summary to JSON
        run: |
          bq query --use_legacy_sql=false --format=json --location=US '
            SELECT
              COUNTIF(visitor_segment = "converter") as converters,
              COUNTIF(visitor_segment = "high_intent") as high_intent,
              COUNTIF(visitor_segment = "engaged_explorer") as engaged_explorers,
              COUNTIF(visitor_segment = "returning_visitor") as returning_visitors,
              COUNTIF(visitor_segment = "casual_browser" OR visitor_segment = "engaged_new") as casual_browsers
            FROM `portfolio-483605.analytics_processed.v_visitor_insights`
          ' > /tmp/visitor-segments.json || echo '{}' > /tmp/visitor-segments.json

      - name: Export Conversion Funnel to JSON
        run: |
          bq query --use_legacy_sql=false --format=json --location=US '
            SELECT
              SUM(total_cta_views) as cta_views,
              SUM(total_cta_clicks) as cta_clicks,
              SUM(contact_form_starts) as form_starts,
              SUM(contact_form_submissions) as form_submissions,
              SUM(resume_downloads) as resume_downloads,
              SUM(social_clicks) as social_clicks
            FROM `portfolio-483605.analytics_processed.v_conversion_funnel`
            WHERE event_date >= DATE_SUB(CURRENT_DATE(), INTERVAL 7 DAY)
          ' > /tmp/conversion-funnel.json || echo '{}' > /tmp/conversion-funnel.json

      - name: Export Domain Rankings to JSON
        run: |
          bq query --use_legacy_sql=false --format=json --location=US '
            SELECT
              domain,
              interest_rank,
              total_interest_score,
              demand_tier,
              portfolio_recommendation
            FROM `portfolio-483605.analytics_materialized.domain_rankings`
            ORDER BY interest_rank
          ' > /tmp/domain-rankings.json || echo '[]' > /tmp/domain-rankings.json

      - name: Export Experience Rankings to JSON
        run: |
          bq query --use_legacy_sql=false --format=json --location=US '
            SELECT
              job_title as role_title,
              company as company_name,
              interest_rank,
              total_interest_score as interest_score
            FROM `portfolio-483605.analytics_materialized.experience_rankings`
            ORDER BY interest_rank
            LIMIT 10
          ' > /tmp/experience-rankings.json || echo '[]' > /tmp/experience-rankings.json

      - name: Export Recommendation Performance to JSON
        run: |
          bq query --use_legacy_sql=false --format=json --location=US '
            SELECT
              system_health,
              ROUND(overall_ctr, 1) as overall_ctr,
              ROUND(position_1_ctr, 1) as position_1_ctr,
              ROUND(position_2_ctr, 1) as position_2_ctr,
              ROUND(position_3_ctr, 1) as position_3_ctr,
              ROUND(user_conversion_rate, 1) as user_conversion_rate,
              COALESCE(total_impressions, 0) as total_impressions,
              COALESCE(total_clicks, 0) as total_clicks
            FROM `portfolio-483605.analytics_materialized.recommendation_performance`
          ' > /tmp/recommendations.json || echo '{}' > /tmp/recommendations.json

      - name: Export Section Rankings with Full Details to JSON
        run: |
          bq query --use_legacy_sql=false --format=json --location=US '
            SELECT
              section_id,
              ROUND(health_score, 1) as health_score,
              engagement_rank,
              health_tier,
              optimization_hint,
              COALESCE(total_views, 0) as total_views,
              ROUND(COALESCE(avg_engagement_rate, 0), 1) as avg_engagement_rate,
              ROUND(COALESCE(avg_exit_rate, 0), 1) as avg_exit_rate
            FROM `portfolio-483605.analytics_materialized.section_rankings`
            ORDER BY engagement_rank
          ' > /tmp/section-rankings-full.json || echo '[]' > /tmp/section-rankings-full.json

      - name: Update Dashboard Gist
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
          DASHBOARD_GIST_ID: ${{ secrets.DASHBOARD_GIST_ID }}
        run: |
          # Skip if DASHBOARD_GIST_ID is not set
          if [ -z "$DASHBOARD_GIST_ID" ]; then
            echo "DASHBOARD_GIST_ID not set, skipping dashboard gist update"
            echo "To enable: Create a new Gist and add its ID as DASHBOARD_GIST_ID secret"
            exit 0
          fi

          # Ensure all files have valid JSON arrays
          for f in /tmp/daily-metrics.json /tmp/traffic-sources.json /tmp/top-countries.json \
                   /tmp/domain-rankings.json /tmp/experience-rankings.json \
                   /tmp/section-rankings-full.json /tmp/skill-rankings.json \
                   /tmp/project-rankings.json /tmp/client-rankings.json; do
            if ! jq empty "$f" 2>/dev/null; then
              echo '[]' > "$f"
            fi
          done

          # Ensure object files have valid JSON objects
          for f in /tmp/visitor-segments.json /tmp/conversion-funnel.json /tmp/recommendations.json; do
            if ! jq empty "$f" 2>/dev/null; then
              echo '[{}]' > "$f"
            fi
          done

          # Calculate overview metrics with proper error handling
          OVERVIEW_RAW=$(bq query --use_legacy_sql=false --format=json --location=US '
            SELECT
              COALESCE(SUM(unique_visitors), 0) as total_visitors_7d,
              COALESCE(SUM(total_sessions), 0) as total_sessions_7d,
              ROUND(COALESCE(AVG(engagement_rate), 0), 1) as engagement_rate,
              ROUND(COALESCE(AVG(bounce_rate), 0), 1) as bounce_rate,
              ROUND(COALESCE(AVG(avg_session_duration_sec), 0), 0) as avg_session_duration_sec
            FROM `portfolio-483605.analytics_processed.v_daily_metrics`
            WHERE session_date >= DATE_SUB(CURRENT_DATE(), INTERVAL 7 DAY)
          ' 2>/dev/null || echo '[]')

          if echo "$OVERVIEW_RAW" | jq empty 2>/dev/null; then
            OVERVIEW=$(echo "$OVERVIEW_RAW" | jq '.[0] // {"total_visitors_7d":0,"total_sessions_7d":0,"engagement_rate":0,"bounce_rate":0,"avg_session_duration_sec":0}')
          else
            OVERVIEW='{"total_visitors_7d":0,"total_sessions_7d":0,"engagement_rate":0,"bounce_rate":0,"avg_session_duration_sec":0}'
          fi

          CONVERSIONS_RAW=$(bq query --use_legacy_sql=false --format=json --location=US '
            SELECT
              COALESCE(SUM(contact_form_submissions), 0) as total_conversions,
              COALESCE(SUM(resume_downloads), 0) as resume_downloads
            FROM `portfolio-483605.analytics_processed.v_conversion_funnel`
            WHERE event_date >= DATE_SUB(CURRENT_DATE(), INTERVAL 7 DAY)
          ' 2>/dev/null || echo '[]')

          if echo "$CONVERSIONS_RAW" | jq empty 2>/dev/null; then
            CONVERSIONS=$(echo "$CONVERSIONS_RAW" | jq '.[0] // {"total_conversions":0,"resume_downloads":0}')
          else
            CONVERSIONS='{"total_conversions":0,"resume_downloads":0}'
          fi

          # Safely merge overview and conversions
          COMBINED_OVERVIEW=$(echo "$OVERVIEW" "$CONVERSIONS" | jq -s '.[0] * .[1]')

          # Helper function to safely get first element or empty object
          get_first_or_empty() {
            local file=$1
            if [ -f "$file" ]; then
              jq '.[0] // {}' "$file" 2>/dev/null || echo '{}'
            else
              echo '{}'
            fi
          }

          # Combine into dashboard JSON with safe defaults
          jq -n \
            --argjson overview "$COMBINED_OVERVIEW" \
            --argjson dailyMetrics "$(cat /tmp/daily-metrics.json 2>/dev/null || echo '[]')" \
            --argjson trafficSources "$(cat /tmp/traffic-sources.json 2>/dev/null || echo '[]')" \
            --argjson topCountries "$(cat /tmp/top-countries.json 2>/dev/null || echo '[]')" \
            --argjson visitorSegments "$(jq '.[0] // {}' /tmp/visitor-segments.json 2>/dev/null || echo '{}')" \
            --argjson conversionFunnel "$(jq '.[0] // {}' /tmp/conversion-funnel.json 2>/dev/null || echo '{}')" \
            --argjson recommendations "$(jq '.[0] // {}' /tmp/recommendations.json 2>/dev/null || echo '{}')" \
            --argjson domains "$(cat /tmp/domain-rankings.json 2>/dev/null || echo '[]')" \
            --argjson experiences "$(cat /tmp/experience-rankings.json 2>/dev/null || echo '[]')" \
            --argjson skills "$(cat /tmp/skill-rankings.json 2>/dev/null || echo '[]')" \
            --argjson projects "$(cat /tmp/project-rankings.json 2>/dev/null || echo '[]')" \
            --argjson sections "$(cat /tmp/section-rankings-full.json 2>/dev/null || echo '[]')" \
            --argjson clients "$(cat /tmp/client-rankings.json 2>/dev/null || echo '[]')" \
            --arg updated_at "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            '{
              overview: $overview,
              dailyMetrics: $dailyMetrics,
              trafficSources: $trafficSources,
              topCountries: $topCountries,
              visitorSegments: $visitorSegments,
              conversionFunnel: $conversionFunnel,
              recommendations: $recommendations,
              domains: $domains,
              experiences: $experiences,
              skills: $skills,
              projects: $projects,
              sections: $sections,
              clients: $clients,
              updated_at: $updated_at
            }' > /tmp/dashboard.json

          echo "Dashboard JSON preview:"
          cat /tmp/dashboard.json | head -50

          # Update Dashboard Gist
          RESPONSE=$(curl -s -X PATCH \
            -H "Authorization: token $GIST_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/gists/$DASHBOARD_GIST_ID" \
            -d "$(jq -n --arg content "$(cat /tmp/dashboard.json)" '{files: {"dashboard-analytics.json": {content: $content}}}')")

          if echo "$RESPONSE" | grep -q '"id"'; then
            echo "Dashboard Gist updated successfully!"
          else
            echo "Warning: Dashboard Gist update may have failed"
            echo "$RESPONSE" | head -20
          fi

      - name: Summary
        run: |
          echo "========================================"
          echo "Materialization Complete!"
          echo "========================================"
          echo "Tables updated in analytics_materialized:"
          echo "  - section_rankings"
          echo "  - project_rankings"
          echo "  - skill_rankings"
          echo "  - client_rankings"
          echo "  - domain_rankings"
          echo "  - experience_rankings"
          echo "  - tech_demand_insights"
          echo "  - visitor_insights"
          echo "  - conversion_funnel"
          echo "  - recommendation_performance"
          echo ""
          echo "GitHub Gists updated:"
          echo "  - Rankings: https://gist.github.com/AbhinavSarkarr/7983bb85c69ec4cc45fe37b6a8d2d391"
          echo "  - Dashboard: https://gist.github.com/AbhinavSarkarr/dedbbf6ebcb32542e7b724b86f2b214f"
          echo "========================================"
          echo "Timestamp: $(date)"
