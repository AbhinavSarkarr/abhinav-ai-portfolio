# BigQuery Analytics Materialization
# Runs daily at 2:00 PM IST (8:30 UTC) to materialize analytics views into tables
# and export data to GitHub Gists for the portfolio and dashboard

name: Materialize BigQuery Analytics

on:
  schedule:
    - cron: '30 8 * * *'
  workflow_dispatch:

jobs:
  materialize:
    name: Materialize Analytics Tables
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_CREDENTIALS }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: portfolio-483605

      - name: Create materialized dataset if not exists
        run: |
          bq mk --dataset --location=US portfolio-483605:analytics_materialized || true

      # ==================== MATERIALIZE VIEWS ====================
      - name: Materialize All Rankings Views
        run: |
          echo "Materializing section_rankings..."
          bq query --use_legacy_sql=false --location=US '
            CREATE OR REPLACE TABLE `portfolio-483605.analytics_materialized.section_rankings` AS
            SELECT *, CURRENT_TIMESTAMP() as materialized_at
            FROM `portfolio-483605.analytics_processed.v_section_rankings`
          ' || echo "Warning: section_rankings failed"

          echo "Materializing project_rankings..."
          bq query --use_legacy_sql=false --location=US '
            CREATE OR REPLACE TABLE `portfolio-483605.analytics_materialized.project_rankings` AS
            SELECT *, CURRENT_TIMESTAMP() as materialized_at
            FROM `portfolio-483605.analytics_processed.v_project_rankings`
          ' || echo "Warning: project_rankings failed"

          echo "Materializing tech_demand_insights (skills)..."
          bq query --use_legacy_sql=false --location=US '
            CREATE OR REPLACE TABLE `portfolio-483605.analytics_materialized.tech_demand_insights` AS
            SELECT *, CURRENT_TIMESTAMP() as materialized_at
            FROM `portfolio-483605.analytics_processed.v_tech_demand_insights`
          ' || echo "Warning: tech_demand_insights failed"

          echo "Materializing client_rankings..."
          bq query --use_legacy_sql=false --location=US '
            CREATE OR REPLACE TABLE `portfolio-483605.analytics_materialized.client_rankings` AS
            SELECT *, CURRENT_TIMESTAMP() as materialized_at
            FROM `portfolio-483605.analytics_processed.v_client_rankings`
          ' || echo "Warning: client_rankings failed"

          echo "Materializing domain_rankings..."
          bq query --use_legacy_sql=false --location=US '
            CREATE OR REPLACE TABLE `portfolio-483605.analytics_materialized.domain_rankings` AS
            SELECT *, CURRENT_TIMESTAMP() as materialized_at
            FROM `portfolio-483605.analytics_processed.v_domain_rankings`
          ' || echo "Warning: domain_rankings failed"

          echo "Materializing experience_rankings..."
          bq query --use_legacy_sql=false --location=US '
            CREATE OR REPLACE TABLE `portfolio-483605.analytics_materialized.experience_rankings` AS
            SELECT *, CURRENT_TIMESTAMP() as materialized_at
            FROM `portfolio-483605.analytics_processed.v_experience_rankings`
          ' || echo "Warning: experience_rankings failed"

          echo "Materializing recommendation_performance..."
          bq query --use_legacy_sql=false --location=US '
            CREATE OR REPLACE TABLE `portfolio-483605.analytics_materialized.recommendation_performance` AS
            SELECT *, CURRENT_TIMESTAMP() as materialized_at
            FROM `portfolio-483605.analytics_processed.v_recommendation_performance`
          ' || echo "Warning: recommendation_performance failed"

          echo "All materializations complete"

      # ==================== EXPORT DATA TO JSON ====================
      - name: Export Rankings Data
        run: |
          # Skills
          bq query --use_legacy_sql=false --format=json --location=US '
            SELECT
              COALESCE(technology, "Unknown") as skill_name,
              COALESCE(skill_category, "Other") as skill_category,
              COALESCE(total_interest_signals, 0) as clicks,
              COALESCE(demand_rank, 999) as demand_rank,
              COALESCE(demand_tier, "niche") as demand_tier,
              COALESCE(learning_priority, "maintain_expertise") as learning_priority
            FROM `portfolio-483605.analytics_materialized.tech_demand_insights`
            ORDER BY demand_rank
          ' > /tmp/skill-rankings.json 2>/dev/null || echo '[]' > /tmp/skill-rankings.json

          # Projects
          bq query --use_legacy_sql=false --format=json --location=US '
            SELECT
              COALESCE(project_id, "unknown") as project_id,
              COALESCE(project_title, "Unknown Project") as project_title,
              COALESCE(overall_rank, 999) as overall_rank,
              COALESCE(total_views, 0) as total_views,
              COALESCE(total_clicks, 0) as total_clicks,
              COALESCE(engagement_score, 0) as engagement_score,
              COALESCE(recommended_position, "primary") as recommended_position
            FROM `portfolio-483605.analytics_materialized.project_rankings`
            ORDER BY overall_rank
          ' > /tmp/project-rankings.json 2>/dev/null || echo '[]' > /tmp/project-rankings.json

          # Sections (use actual column names from deployed view)
          bq query --use_legacy_sql=false --format=json --location=US '
            SELECT
              COALESCE(section_id, "unknown") as section_id,
              ROUND(COALESCE(health_score, 50), 1) as health_score,
              COALESCE(engagement_rank, 999) as engagement_rank,
              COALESCE(health_tier, "needs_attention") as health_tier,
              COALESCE(dropoff_indicator, "moderate_dropoff") as optimization_hint,
              COALESCE(total_views, 0) as total_views,
              ROUND(COALESCE(health_score, 0) / 3, 1) as avg_engagement_rate,
              ROUND(COALESCE(avg_exit_rate, 0), 1) as avg_exit_rate
            FROM `portfolio-483605.analytics_materialized.section_rankings`
            ORDER BY engagement_rank
          ' > /tmp/section-rankings.json 2>/dev/null || echo '[]' > /tmp/section-rankings.json

          # Clients
          bq query --use_legacy_sql=false --format=json --location=US '
            SELECT
              COALESCE(client_id, "unknown") as client_id,
              COALESCE(client_name, "Unknown Client") as client_name,
              COALESCE(experience_id, "exp1") as experience_id,
              COALESCE(domain, "Other") as domain,
              COALESCE(engagement_rank, 999) as engagement_rank,
              COALESCE(total_views, 0) as total_views,
              COALESCE(total_clicks, 0) as total_clicks
            FROM `portfolio-483605.analytics_materialized.client_rankings`
            ORDER BY experience_id, engagement_rank
          ' > /tmp/client-rankings.json 2>/dev/null || echo '[]' > /tmp/client-rankings.json

          # Domains
          bq query --use_legacy_sql=false --format=json --location=US '
            SELECT
              COALESCE(domain, "Unknown") as domain,
              COALESCE(interest_rank, 999) as interest_rank,
              COALESCE(total_interest_score, 0) as total_interest_score,
              COALESCE(demand_tier, "niche_interest") as demand_tier,
              COALESCE(portfolio_recommendation, "maintain") as portfolio_recommendation
            FROM `portfolio-483605.analytics_materialized.domain_rankings`
            ORDER BY interest_rank
          ' > /tmp/domain-rankings.json 2>/dev/null || echo '[]' > /tmp/domain-rankings.json

          # Experiences (use actual column names from deployed view)
          bq query --use_legacy_sql=false --format=json --location=US '
            SELECT
              COALESCE(experience_id, "unknown") as role_title,
              COALESCE(experience_id, "unknown") as company_name,
              COALESCE(experience_rank, 999) as interest_rank,
              COALESCE(total_interactions, 0) as interest_score
            FROM `portfolio-483605.analytics_materialized.experience_rankings`
            ORDER BY experience_rank
            LIMIT 10
          ' > /tmp/experience-rankings.json 2>/dev/null || echo '[]' > /tmp/experience-rankings.json

          # Recommendations (use actual column names from deployed view)
          bq query --use_legacy_sql=false --format=json --location=US '
            SELECT
              CASE WHEN COALESCE(click_through_rate, 0) >= 5 THEN "good"
                   WHEN COALESCE(click_through_rate, 0) >= 2 THEN "needs_improvement"
                   ELSE "underperforming" END as system_health,
              ROUND(COALESCE(click_through_rate, 0), 1) as overall_ctr,
              0 as position_1_ctr,
              0 as position_2_ctr,
              0 as position_3_ctr,
              0 as user_conversion_rate,
              COALESCE(times_shown, 0) as total_impressions,
              COALESCE(times_clicked, 0) as total_clicks
            FROM `portfolio-483605.analytics_materialized.recommendation_performance`
            WHERE metric_type = "recommendations"
            LIMIT 1
          ' > /tmp/recommendations.json 2>/dev/null || echo '[{}]' > /tmp/recommendations.json

          echo "Rankings data exported"

      - name: Export Dashboard Metrics
        run: |
          # Daily metrics (last 30 days, excluding today due to GA4 delay)
          bq query --use_legacy_sql=false --format=json --location=US '
            SELECT
              FORMAT_DATE("%Y-%m-%d", session_date) as date,
              COALESCE(unique_visitors, 0) as visitors,
              COALESCE(total_sessions, 0) as sessions,
              ROUND(COALESCE(engagement_rate, 0), 1) as engagement_rate,
              ROUND(COALESCE(bounce_rate, 0), 1) as bounce_rate,
              ROUND(COALESCE(avg_session_duration_sec, 0), 0) as avg_session_duration_sec,
              COALESCE(desktop_sessions, 0) as desktop,
              COALESCE(mobile_sessions, 0) as mobile,
              COALESCE(tablet_sessions, 0) as tablet
            FROM `portfolio-483605.analytics_processed.v_daily_metrics`
            WHERE session_date >= DATE_SUB(CURRENT_DATE(), INTERVAL 31 DAY)
              AND session_date <= DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY)
            ORDER BY session_date DESC
            LIMIT 30
          ' > /tmp/daily-metrics.json 2>/dev/null || echo '[]' > /tmp/daily-metrics.json

          # Traffic sources
          bq query --use_legacy_sql=false --format=json --location=US '
            SELECT
              COALESCE(traffic_source, "direct") as source,
              COALESCE(traffic_medium, "none") as medium,
              COALESCE(SUM(sessions), 0) as sessions,
              ROUND(COALESCE(AVG(engagement_rate), 0), 1) as engagement_rate
            FROM `portfolio-483605.analytics_processed.v_traffic_daily_stats`
            WHERE event_date >= DATE_SUB(CURRENT_DATE(), INTERVAL 8 DAY)
              AND event_date <= DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY)
            GROUP BY traffic_source, traffic_medium
            ORDER BY sessions DESC
            LIMIT 10
          ' > /tmp/traffic-sources.json 2>/dev/null || echo '[]' > /tmp/traffic-sources.json

          # Top countries
          bq query --use_legacy_sql=false --format=json --location=US '
            SELECT
              COALESCE(country, "Unknown") as country,
              COUNT(DISTINCT user_pseudo_id) as visitors
            FROM `portfolio-483605.analytics_processed.v_sessions`
            WHERE session_date >= DATE_SUB(CURRENT_DATE(), INTERVAL 8 DAY)
              AND session_date <= DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY)
            GROUP BY country
            HAVING visitors > 0
            ORDER BY visitors DESC
            LIMIT 10
          ' > /tmp/top-countries.json 2>/dev/null || echo '[]' > /tmp/top-countries.json

          # Visitor segments
          bq query --use_legacy_sql=false --format=json --location=US '
            SELECT
              COALESCE(COUNTIF(visitor_segment = "converter"), 0) as converters,
              COALESCE(COUNTIF(visitor_segment = "high_intent"), 0) as high_intent,
              COALESCE(COUNTIF(visitor_segment = "engaged_explorer"), 0) as engaged_explorers,
              COALESCE(COUNTIF(visitor_segment = "returning_visitor"), 0) as returning_visitors,
              COALESCE(COUNTIF(visitor_segment = "casual_browser" OR visitor_segment = "engaged_new"), 0) as casual_browsers
            FROM `portfolio-483605.analytics_processed.v_visitor_insights`
          ' > /tmp/visitor-segments.json 2>/dev/null || echo '[{}]' > /tmp/visitor-segments.json

          # Conversion funnel
          bq query --use_legacy_sql=false --format=json --location=US '
            SELECT
              COALESCE(SUM(total_cta_views), 0) as cta_views,
              COALESCE(SUM(total_cta_clicks), 0) as cta_clicks,
              COALESCE(SUM(contact_form_starts), 0) as form_starts,
              COALESCE(SUM(contact_form_submissions), 0) as form_submissions,
              COALESCE(SUM(resume_downloads), 0) as resume_downloads,
              COALESCE(SUM(social_clicks), 0) as social_clicks
            FROM `portfolio-483605.analytics_processed.v_conversion_funnel`
            WHERE event_date >= DATE_SUB(CURRENT_DATE(), INTERVAL 8 DAY)
              AND event_date <= DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY)
          ' > /tmp/conversion-funnel.json 2>/dev/null || echo '[{}]' > /tmp/conversion-funnel.json

          echo "Dashboard metrics exported"

      # ==================== UPDATE GISTS ====================
      - name: Update Portfolio Rankings Gist
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
        run: |
          # Validate JSON files
          for f in /tmp/skill-rankings.json /tmp/project-rankings.json /tmp/section-rankings.json /tmp/client-rankings.json; do
            jq empty "$f" 2>/dev/null || echo '[]' > "$f"
          done

          # Combine rankings
          jq -n \
            --argjson skills "$(cat /tmp/skill-rankings.json)" \
            --argjson projects "$(cat /tmp/project-rankings.json)" \
            --argjson sections "$(cat /tmp/section-rankings.json)" \
            --argjson clients "$(cat /tmp/client-rankings.json)" \
            --arg updated_at "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            '{skills: $skills, projects: $projects, sections: $sections, clients: $clients, updated_at: $updated_at}' \
            > /tmp/rankings.json

          # Update Gist
          curl -s -X PATCH \
            -H "Authorization: token $GIST_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/gists/7983bb85c69ec4cc45fe37b6a8d2d391 \
            -d "$(jq -n --arg content "$(cat /tmp/rankings.json)" '{files: {"skill-rankings.json": {content: $content}}}')" \
            | grep -q '"id"' && echo "Rankings Gist updated!" || echo "Warning: Rankings Gist update failed"

      - name: Update Dashboard Gist
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
          DASHBOARD_GIST_ID: ${{ secrets.DASHBOARD_GIST_ID }}
        run: |
          if [ -z "$DASHBOARD_GIST_ID" ]; then
            echo "DASHBOARD_GIST_ID not set, skipping"
            exit 0
          fi

          # Validate JSON files
          for f in /tmp/daily-metrics.json /tmp/traffic-sources.json /tmp/top-countries.json \
                   /tmp/domain-rankings.json /tmp/experience-rankings.json /tmp/section-rankings.json \
                   /tmp/skill-rankings.json /tmp/project-rankings.json /tmp/client-rankings.json; do
            jq empty "$f" 2>/dev/null || echo '[]' > "$f"
          done
          for f in /tmp/visitor-segments.json /tmp/conversion-funnel.json /tmp/recommendations.json; do
            jq empty "$f" 2>/dev/null || echo '[{}]' > "$f"
          done

          # Calculate overview (7-day summary)
          OVERVIEW=$(bq query --use_legacy_sql=false --format=json --location=US '
            SELECT
              COALESCE(SUM(unique_visitors), 0) as total_visitors_7d,
              COALESCE(SUM(total_sessions), 0) as total_sessions_7d,
              ROUND(COALESCE(AVG(engagement_rate), 0), 1) as engagement_rate,
              ROUND(COALESCE(AVG(bounce_rate), 0), 1) as bounce_rate,
              ROUND(COALESCE(AVG(avg_session_duration_sec), 0), 0) as avg_session_duration_sec
            FROM `portfolio-483605.analytics_processed.v_daily_metrics`
            WHERE session_date >= DATE_SUB(CURRENT_DATE(), INTERVAL 8 DAY)
              AND session_date <= DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY)
          ' 2>/dev/null | jq '.[0] // {}' || echo '{}')

          CONVERSIONS=$(bq query --use_legacy_sql=false --format=json --location=US '
            SELECT
              COALESCE(SUM(contact_form_submissions), 0) as total_conversions,
              COALESCE(SUM(resume_downloads), 0) as resume_downloads
            FROM `portfolio-483605.analytics_processed.v_conversion_funnel`
            WHERE event_date >= DATE_SUB(CURRENT_DATE(), INTERVAL 8 DAY)
              AND event_date <= DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY)
          ' 2>/dev/null | jq '.[0] // {}' || echo '{}')

          COMBINED_OVERVIEW=$(echo "$OVERVIEW" "$CONVERSIONS" | jq -s '.[0] * .[1]')

          # Build dashboard JSON
          jq -n \
            --argjson overview "$COMBINED_OVERVIEW" \
            --argjson dailyMetrics "$(cat /tmp/daily-metrics.json)" \
            --argjson trafficSources "$(cat /tmp/traffic-sources.json)" \
            --argjson topCountries "$(cat /tmp/top-countries.json)" \
            --argjson visitorSegments "$(jq '.[0] // {}' /tmp/visitor-segments.json)" \
            --argjson conversionFunnel "$(jq '.[0] // {}' /tmp/conversion-funnel.json)" \
            --argjson recommendations "$(jq '.[0] // {}' /tmp/recommendations.json)" \
            --argjson domains "$(cat /tmp/domain-rankings.json)" \
            --argjson experiences "$(cat /tmp/experience-rankings.json)" \
            --argjson skills "$(cat /tmp/skill-rankings.json)" \
            --argjson projects "$(cat /tmp/project-rankings.json)" \
            --argjson sections "$(cat /tmp/section-rankings.json)" \
            --argjson clients "$(cat /tmp/client-rankings.json)" \
            --arg updated_at "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            '{
              overview: $overview,
              dailyMetrics: $dailyMetrics,
              trafficSources: $trafficSources,
              topCountries: $topCountries,
              visitorSegments: $visitorSegments,
              conversionFunnel: $conversionFunnel,
              recommendations: $recommendations,
              domains: $domains,
              experiences: $experiences,
              skills: $skills,
              projects: $projects,
              sections: $sections,
              clients: $clients,
              updated_at: $updated_at
            }' > /tmp/dashboard.json

          # Update Gist
          curl -s -X PATCH \
            -H "Authorization: token $GIST_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/gists/$DASHBOARD_GIST_ID" \
            -d "$(jq -n --arg content "$(cat /tmp/dashboard.json)" '{files: {"dashboard-analytics.json": {content: $content}}}')" \
            | grep -q '"id"' && echo "Dashboard Gist updated!" || echo "Warning: Dashboard Gist update failed"

      - name: Summary
        run: |
          echo "========================================"
          echo "Materialization Complete!"
          echo "========================================"
          echo "Gists updated:"
          echo "  - Rankings: https://gist.github.com/AbhinavSarkarr/7983bb85c69ec4cc45fe37b6a8d2d391"
          echo "  - Dashboard: https://gist.github.com/AbhinavSarkarr/dedbbf6ebcb32542e7b724b86f2b214f"
          echo "========================================"
